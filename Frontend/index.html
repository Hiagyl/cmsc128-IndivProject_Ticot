<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TODO LIST</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">
    <h1 class="text-3xl font-bold mb-6">TODO LIST</h1>

    <!-- Top bar -->
    <div class="flex justify-between items-center w-full max-w-2xl mb-6">
        <button id="openModalBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">
            + Add Task
        </button>

        <!-- Filter dropdown -->
        <div class="relative">
            <button id="filterBtn"
                class="flex items-center space-x-2 px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M10.5 6h9.75M3.75 6h3.75m0 0V3.75m0 2.25V8.25m6.75 9.75h9.75M3.75 18h3.75m0 0v-2.25m0 2.25V20.25" />
                </svg>
                <span id="filterLabel">Filter</span>
            </button>

            <!-- Dropdown menu -->
            <div id="filterMenu" class="hidden absolute right-0 mt-2 w-40 bg-white shadow-lg rounded-lg z-10">
                <button data-sort="dateAdded" class="w-full text-left px-4 py-2 hover:bg-gray-100">By Date
                    Added</button>
                <button data-sort="dueDate" class="w-full text-left px-4 py-2 hover:bg-gray-100">By Due Date</button>
                <button data-sort="priority" class="w-full text-left px-4 py-2 hover:bg-gray-100">By Priority</button>
            </div>
        </div>
    </div>

    <!-- Task list -->
    <div id="taskList" class="w-full max-w-2xl space-y-3 mb-6 text-center text-gray-500">
        Loading tasks...
    </div>

    <!-- Add Task Button -->
    <div class="w-full max-w-2xl">
        <button id="openModalBtn2" class="w-full bg-blue-600 text-white py-3 rounded-lg shadow hover:bg-blue-700">
            + Add Task
        </button>
    </div>

    <!-- Add Task Modal -->
    <div id="taskModal" class="fixed inset-0 hidden bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white w-full max-w-md p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold mb-4">Add New Task</h2>
            <form id="taskForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Task Title</label>
                    <input type="text" id="taskTitle" class="w-full mt-1 p-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Due Date</label>
                    <input type="date" id="taskDate" class="w-full mt-1 p-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Due Time</label>
                    <input type="time" id="taskTime" class="w-full mt-1 p-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Priority</label>
                    <select id="taskPriority" class="w-full mt-1 p-2 border rounded-lg" required>
                        <option value="high">High</option>
                        <option value="mid">Mid</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelModalBtn"
                        class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Confirm</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="editModal" class="fixed inset-0 hidden bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white w-full max-w-md p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold mb-4">Edit Task</h2>
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="editId">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Task Title</label>
                    <input type="text" id="editTitle" class="w-full mt-1 p-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Due Date</label>
                    <input type="date" id="editDate" class="w-full mt-1 p-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Due Time</label>
                    <input type="time" id="editTime" class="w-full mt-1 p-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Priority</label>
                    <select id="editPriority" class="w-full mt-1 p-2 border rounded-lg" required>
                        <option value="high">High</option>
                        <option value="mid">Mid</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelEditBtn"
                        class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed bottom-4 right-4 hidden bg-gray-800 text-white px-4 py-2 rounded-lg shadow flex items-center space-x-3">
        <span id="toastMessage">Task deleted</span>
        <button id="undoBtn" class="bg-blue-500 px-2 py-1 rounded hover:bg-blue-600 text-sm">Undo</button>
    </div>

    <script>
        const modal = document.getElementById("taskModal");
        const editModal = document.getElementById("editModal");
        const openModalBtns = [document.getElementById("openModalBtn"), document.getElementById("openModalBtn2")];
        const cancelModalBtn = document.getElementById("cancelModalBtn");
        const cancelEditBtn = document.getElementById("cancelEditBtn");
        const taskList = document.getElementById("taskList");

        const toast = document.getElementById("toast");
        const toastMessage = document.getElementById("toastMessage");
        const undoBtn = document.getElementById("undoBtn");
        let lastDeletedTaskId = null;
        let toastTimeout;

        const filterBtn = document.getElementById("filterBtn");
        const filterMenu = document.getElementById("filterMenu");
        const filterLabel = document.getElementById("filterLabel");
        let currentSort = null;

        let tasksCache = [];

        // Modal controls
        openModalBtns.forEach(btn => btn.addEventListener("click", () => modal.classList.remove("hidden")));
        cancelModalBtn.addEventListener("click", () => modal.classList.add("hidden"));
        cancelEditBtn.addEventListener("click", () => editModal.classList.add("hidden"));

        // Filter dropdown controls
        filterBtn.addEventListener("click", () => filterMenu.classList.toggle("hidden"));
        document.addEventListener("click", (e) => {
            if (!filterBtn.contains(e.target) && !filterMenu.contains(e.target)) filterMenu.classList.add("hidden");
        });
        filterMenu.querySelectorAll("button").forEach(btn => {
            btn.addEventListener("click", async (e) => {
                currentSort = e.target.dataset.sort;
                filterLabel.textContent = "Filter: " + e.target.textContent;
                filterMenu.classList.add("hidden");
                await loadTasks();
            });
        });

        function formatDate(dueDate) {
            if (!dueDate) return "N/A";
            const d = new Date(dueDate);
            return d.toLocaleString();
        }

        function showToast(message, taskId) {
            toastMessage.textContent = message;
            toast.classList.remove("hidden");
            lastDeletedTaskId = taskId;
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.add("hidden");
                lastDeletedTaskId = null;
            }, 5000);
        }

        undoBtn.addEventListener("click", async () => {
            if (!lastDeletedTaskId) return;
            try {
                await fetch(`http://localhost:3000/api/tasks/${lastDeletedTaskId}/restore`, { method: "POST" });
                await loadTasks();
                toast.classList.add("hidden");
                lastDeletedTaskId = null;
            } catch (err) { console.error(err); }
        });

        // Event delegation for task actions
        taskList.addEventListener("click", async (e) => {
            const checkbox = e.target.closest(".taskCheckbox");
            const editBtn = e.target.closest(".editBtn");
            const deleteBtn = e.target.closest(".deleteBtn");

            if (checkbox) {
                const id = checkbox.dataset.id;
                const completed = checkbox.checked;
                try {
                    await fetch(`http://localhost:3000/api/tasks/${id}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ completed })
                    });
                    const titleEl = checkbox.nextElementSibling.querySelector("h2");
                    if (completed) titleEl.classList.add("line-through", "text-gray-400");
                    else titleEl.classList.remove("line-through", "text-gray-400");
                } catch (err) { console.error(err); }
            }

            if (editBtn) {
                const id = editBtn.dataset.id;
                openEditModal(id);
            }

            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                try {
                    const res = await fetch(`http://localhost:3000/api/tasks/${id}`, { method: "DELETE" });
                    if (res.ok) {
                        showToast("Task deleted", id);
                        deleteBtn.closest("div.bg-white").remove();
                    }
                } catch (err) { console.error(err); }
            }
        });

        function openEditModal(id) {
            const task = tasksCache.find(t => t._id === id);
            if (!task) return;
            document.getElementById("editId").value = task._id;
            document.getElementById("editTitle").value = task.title;
            if (task.dueDate) {
                const d = new Date(task.dueDate);
                document.getElementById("editDate").value = d.toISOString().split("T")[0];
                document.getElementById("editTime").value = d.toISOString().split("T")[1].slice(0, 5);
            }
            document.getElementById("editPriority").value = task.priority;
            editModal.classList.remove("hidden");
        }

        // Add task
        document.getElementById("taskForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const dueDate = new Date(document.getElementById("taskDate").value + "T" + document.getElementById("taskTime").value);
            const newTask = {
                title: document.getElementById("taskTitle").value,
                dueDate,
                priority: document.getElementById("taskPriority").value,
                completed: false
            };
            try {
                const res = await fetch("http://localhost:3000/api/tasks", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(newTask)
                });
                if (res.ok) {
                    modal.classList.add("hidden");
                    e.target.reset();
                    await loadTasks();
                } else alert("Error adding task");
            } catch {
                alert("Error connecting to server");
            }
        });

        // Edit task
        document.getElementById("editForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = document.getElementById("editId").value;
            const dueDate = new Date(document.getElementById("editDate").value + "T" + document.getElementById("editTime").value);
            const updatedTask = {
                title: document.getElementById("editTitle").value,
                dueDate,
                priority: document.getElementById("editPriority").value
            };
            try {
                const res = await fetch(`http://localhost:3000/api/tasks/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(updatedTask)
                });
                if (res.ok) {
                    editModal.classList.add("hidden");
                    await loadTasks();
                } else alert("Error updating task");
            } catch {
                alert("Error connecting to server");
            }
        });

        // Load tasks
        async function loadTasks() {
            taskList.innerHTML = "Loading tasks...";
            try {
                let url = "http://localhost:3000/api/tasks";
                if (currentSort) url += `?sort=${currentSort}`;
                const res = await fetch(url);
                const tasks = await res.json();
                tasksCache = tasks;
                if (!tasks.length) {
                    taskList.innerHTML = `<p class="text-gray-500">You have no task yet. Add new tasks?</p>`;
                    return;
                }
                taskList.innerHTML = "";
                tasks.forEach(task => {
                    const priorityColor = task.priority === "high" ? "bg-red-500" :
                        task.priority === "mid" ? "bg-yellow-500" : "bg-green-500";
                    const card = document.createElement("div");
                    card.className = "bg-white shadow p-4 rounded-lg flex items-center";
                    card.innerHTML = `
          <div class="w-2 h-12 rounded-lg mr-3 ${priorityColor}"></div>
          <div class="flex items-center space-x-3 flex-grow">
            <input type="checkbox" class="taskCheckbox w-5 h-5 text-blue-600 rounded" data-id="${task._id}" ${task.completed ? "checked" : ""}>
            <div>
              <h2 class="font-semibold text-lg ${task.completed ? "line-through text-gray-400" : ""}">${task.title}</h2>
              <p class="text-gray-500 text-sm">Due: ${formatDate(task.dueDate)}</p>
              <p class="text-gray-500 text-sm">Timestamp: ${formatDate(task.createdAt)}</p>
            </div>
          </div>
          <div class="flex space-x-2">
            <button class="editBtn text-yellow-500 hover:text-yellow-600" title="Edit Task" data-id="${task._id}"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg></button>
            <button class="deleteBtn text-red-500 hover:text-red-600" title="Delete Task" data-id="${task._id}"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
</button>
          </div>
        `;
                    taskList.appendChild(card);
                });
            } catch (err) {
                taskList.innerHTML = `<p class="text-red-500">Error loading tasks</p>`;
                console.error(err);
            }
        }

        // Initial load
        loadTasks();
    </script>
</body>

</html>